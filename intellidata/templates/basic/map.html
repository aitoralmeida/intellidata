{% set link="basic" %}
{% set title="Zipcode" %}
{% extends "master.html" %}
{% block body %}
    
    <div class="container text-center">
        <div class="alert alert-error" id="error_message">
            <h1>There was an error accessing data. Check <a href="{{ url_for('.zipcode_map_file', zipcode = zipcode) }}">this</a>. </h1>
        </div>
        <div class="alert" id="generating_file_message">
            <h1>Generating map...</h1>
        </div>
        <div class="alert" id="processing_message_alert">
            <h1>Processing map...</h1>
        </div>

        <div id="map"></div>
    </div>

{% endblock %}
{% block scripts %}
        <script src="{{ url_for('static', filename='js/jquery-1.8.3.min.js') }}"></script>
        <script src="{{ url_for('static', filename='js/raphael-min.js') }}"></script>
        <script src="{{ url_for('static', filename='js/kartograph.min.js') }}"></script>
        <script src="{{ url_for('static', filename='js/chroma.min.js') }}"></script>
        <script src="{{ url_for('static', filename='js/jquery.qtip.js') }}"></script>
        <script src="{{ url_for('static', filename='pan-zoom/raphael.pan-zoom.min.js') }}"></script>
        <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='js/jquery.qtip.css') }}"/>
        <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='pan-zoom/raphael.pan-zoom.css') }}"/>

 <script language="JavaScript"> 
var map;
function loadMap(url){

map = Kartograph.map('#map', 600, 0);

 
map.loadMap(url, function(mymap) {

  map.loadCSS('{{ url_for('static', filename='geo/maps.css') }}', function() {
    map.addLayer('background');
    map.addLayer('world');
    map.addLayer('depth');
    map.addLayer('trees');
    map.addLayer('crops');
    map.addLayer('zipcodes');

    setColors();
    $.fn.qtip.defaults.style.classes = 'qtip-light';

    map.getLayer('zipcodes').tooltips(function(data) {
        return [data.zipcode, '<b>' + data.zcode + '</b><br/>Incomes: <b>' + data.incomes + '</b><br/>Cards: <b>'+ data.numcards + '</b><br/>Payments: <b>'+ data.numpay + '</b><br/>Position: <b>' + data.position + '</b>'];
    });

    var panZoom = map.paper.panzoom({ initialZoom: 6, initialPosition: { x: 120, y: 70} });
    panZoom.enable();

    $("#processing_message_alert").hide();

    });
}, { padding: -30 })

}

function setColors(){
    map.getLayer('zipcodes').style('fill', function(data) {

        scale = chroma.scale(['yellow', 'red']);
        var bgColor = scale(data.position / 256.0).hex(); // #FF7F7F
        return bgColor;
    });
    map.getLayer('world').style('fill', function(data) {
        return "#f5f3f2";
    });
    map.getLayer('background').style('fill', function(data) {
        return "#e8f9fb";
    });

}

$(document).ready(function() {
    $("#processing_message_alert").hide();
    $("#error_message").hide();
    $.get( "{{ url_for('.zipcode_map_file', zipcode = zipcode) }}", function() {})
        .done(function(data) {
            $("#generating_file_message").hide();
            $("#processing_message_alert").show();
            var data = $.parseJSON(data);
            loadMap(data["url"]);
        })
        .fail(function() {
            $("#generating_file_message").hide();
            $("#error_message").show();            
        });
});
</script>


{% endblock %}
